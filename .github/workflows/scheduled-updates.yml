name: Scheduled App Updates

on:
  schedule:
    - cron: '5 * * * *'
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch schedules and secrets
        id: fetch
        env:
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "=== Fetching schedules ==="
          SCHEDULES=$(curl -sf "https://fpekzltxukikaixebeeu.supabase.co/rest/v1/update_schedules?enabled=eq.true&select=*" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" || echo "[]")

          SECRETS=$(curl -sf "https://fpekzltxukikaixebeeu.supabase.co/rest/v1/schedule_secrets?select=schedule_id,client_secret" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" || echo "[]")

          [ -z "$SECRETS" ] && SECRETS="[]"
          [ -z "$SCHEDULES" ] && SCHEDULES="[]"

          # Build client_id-to-secret lookup from schedule+secrets join
          # 1. Direct match by schedule_id
          # 2. Fallback: find any secret for same client_id
          MERGED=$(jq -n -c \
            --argjson scheds "$SCHEDULES" \
            --argjson secs "$SECRETS" '
            ($secs | if length > 0 then map({(.schedule_id|tostring): .client_secret}) | add else {} end) as $byId |
            # Build client_id -> secret map by joining schedules that have a secret
            ([$scheds[] | select(.client_id != null) |
              {cid: .client_id, sec: $byId[.id|tostring]}
            ] | map(select(.sec != null)) |
              if length > 0 then map({(.cid): .sec}) | add else {} end
            ) as $byCid |
            $scheds | map(
              . + {client_secret: (
                $byId[.id|tostring] //
                $byCid[.client_id] //
                null
              )}
            )
          ')

          COUNT=$(echo "$MERGED" | jq 'length')
          echo "Found $COUNT enabled schedule(s)"

          echo "data<<ENDOFDATA" >> $GITHUB_OUTPUT
          echo "$MERGED" >> $GITHUB_OUTPUT
          echo "ENDOFDATA" >> $GITHUB_OUTPUT

      - name: Process each schedule
        env:
          DATA: ${{ steps.fetch.outputs.data }}
          SUPA_URL: https://fpekzltxukikaixebeeu.supabase.co
          SUPA_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          set +e

          if [ -z "$DATA" ] || [ "$DATA" = "[]" ] || [ "$DATA" = "null" ]; then
            echo "No enabled schedules."
            exit 0
          fi

          update_status() {
            local sid="$1" status="$2"
            curl -s -X PATCH "$SUPA_URL/rest/v1/update_schedules?id=eq.$sid" \
              -H "apikey: $SUPA_KEY" -H "Authorization: Bearer $SUPA_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"last_run_at\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"last_run_status\":\"$status\"}" >/dev/null 2>&1
          }

          COUNT=$(echo "$DATA" | jq 'length')
          echo "Processing $COUNT schedule(s)..."
          echo ""

          # Write to file so we iterate in main shell (no subshell variable loss)
          TMPFILE=$(mktemp)
          echo "$DATA" | jq -c '.[]' > "$TMPFILE"

          while IFS= read -r sched; do
            ID=$(echo "$sched" | jq -r '.id')
            DAY=$(echo "$sched" | jq -r '.day_of_week')
            TIME=$(echo "$sched" | jq -r '.time_utc')
            TZ_NAME=$(echo "$sched" | jq -r '.timezone // "UTC"')
            ORG=$(echo "$sched" | jq -r '.org_url')
            ENV=$(echo "$sched" | jq -r '.environment_id')
            CID=$(echo "$sched" | jq -r '.client_id // empty')
            CSEC=$(echo "$sched" | jq -r '.client_secret // empty')
            TID=$(echo "$sched" | jq -r '.tenant_id // empty')

            echo "========================================"
            echo "SCHEDULE #$ID"
            echo "  Env:  $ENV"
            echo "  Org:  $ORG"
            echo "  Want: day=$DAY time=$TIME tz=$TZ_NAME"

            NOW_DAY=$(TZ="$TZ_NAME" date +%w)
            NOW_HOUR=$(TZ="$TZ_NAME" date +%H):00
            NOW_FULL=$(TZ="$TZ_NAME" date '+%A %H:%M %Z')
            echo "  Now:  day=$NOW_DAY time=$NOW_HOUR ($NOW_FULL)"

            # --- Credentials check ---
            if [ -z "$CID" ] || [ -z "$TID" ]; then
              echo "  SKIP: missing client_id or tenant_id"
              update_status "$ID" "no_credentials"
              echo ""; continue
            fi
            if [ -z "$CSEC" ] || [ "$CSEC" = "null" ]; then
              echo "  SKIP: no client_secret found"
              update_status "$ID" "no_secret"
              echo ""; continue
            fi
            echo "  Credentials: OK (cid=${CID:0:8}...)"

            # --- Time check ---
            if [ "$DAY" != "$NOW_DAY" ] || [ "$TIME" != "$NOW_HOUR" ]; then
              echo "  SKIP: time mismatch (want day=$DAY $TIME, got day=$NOW_DAY $NOW_HOUR)"
              update_status "$ID" "skipped"
              echo ""; continue
            fi

            echo "  >>> TIME MATCH â€” running updates <<<"

            # --- Get token ---
            echo "  Acquiring token..."
            TRESP=$(curl -s -X POST "https://login.microsoftonline.com/$TID/oauth2/v2.0/token" \
              -d "client_id=$CID&client_secret=$CSEC&grant_type=client_credentials&scope=https://api.powerplatform.com/.default")
            TOKEN=$(echo "$TRESP" | jq -r '.access_token // empty')

            if [ -z "$TOKEN" ]; then
              TERR=$(echo "$TRESP" | jq -r '.error_description // .error // "unknown"')
              echo "  Token FAILED: $TERR"
              update_status "$ID" "token_failed"
              echo ""; continue
            fi
            echo "  Token: OK"

            # --- Fetch installed apps ---
            echo "  Fetching installed apps..."
            INST=$(curl -s "https://api.powerplatform.com/appmanagement/environments/$ENV/applicationPackages?appInstallState=Installed&api-version=2022-03-01-preview" \
              -H "Authorization: Bearer $TOKEN")
            INST_COUNT=$(echo "$INST" | jq '[.value[]?] | length' 2>/dev/null)

            if [ -z "$INST_COUNT" ] || [ "$INST_COUNT" = "0" ] || [ "$INST_COUNT" = "null" ]; then
              echo "  No installed apps or API error"
              echo "  Response preview: $(echo "$INST" | head -c 200)"
              update_status "$ID" "api_error"
              echo ""; continue
            fi
            echo "  Installed apps: $INST_COUNT"

            # --- Fetch catalog ---
            echo "  Fetching catalog..."
            CAT=$(curl -s "https://api.powerplatform.com/appmanagement/environments/$ENV/applicationPackages?api-version=2022-03-01-preview" \
              -H "Authorization: Bearer $TOKEN")
            CAT_COUNT=$(echo "$CAT" | jq '[.value[]?] | length' 2>/dev/null)
            echo "  Catalog apps: $CAT_COUNT"

            # --- Compare and update ---
            UPDATED=0
            FAILED=0

            # Write installed list to file (avoid subshell)
            APP_FILE=$(mktemp)
            echo "$INST" | jq -c '.value[]?' > "$APP_FILE" 2>/dev/null

            while IFS= read -r app; do
              AID=$(echo "$app" | jq -r '.applicationId // empty')
              [ -z "$AID" ] && continue

              ANAME=$(echo "$app" | jq -r '.localizedName // .applicationName // "?"')
              AVER=$(echo "$app" | jq -r '.version // "0"')
              AUNAME=$(echo "$app" | jq -r '.uniqueName // empty')

              CVER=$(echo "$CAT" | jq -r --arg id "$AID" \
                '[.value[]? | select(.applicationId == $id)] | sort_by(.version) | last | .version // empty')
              CUNAME=$(echo "$CAT" | jq -r --arg id "$AID" \
                '[.value[]? | select(.applicationId == $id)] | sort_by(.version) | last | .uniqueName // empty')

              [ -z "$CVER" ] && continue
              [ "$CVER" = "$AVER" ] && continue

              HIGHER=$(printf '%s\n%s' "$AVER" "$CVER" | sort -V | tail -1)
              if [ "$HIGHER" = "$CVER" ] && [ "$HIGHER" != "$AVER" ]; then
                PNAME="${CUNAME:-$AUNAME}"
                echo "  UPDATE: $ANAME  $AVER -> $CVER  (pkg=$PNAME)"

                HTTP=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
                  "https://api.powerplatform.com/appmanagement/environments/$ENV/applicationPackages/$PNAME/install?api-version=2022-03-01-preview" \
                  -H "Authorization: Bearer $TOKEN" \
                  -H "Content-Type: application/json")

                if [ "$HTTP" -ge 200 ] 2>/dev/null && [ "$HTTP" -lt 300 ] 2>/dev/null; then
                  echo "    -> Submitted (HTTP $HTTP)"
                  UPDATED=$((UPDATED + 1))
                else
                  echo "    -> Failed (HTTP $HTTP)"
                  FAILED=$((FAILED + 1))
                fi
              fi
            done < "$APP_FILE"
            rm -f "$APP_FILE"

            echo "  Results: $UPDATED updated, $FAILED failed"
            update_status "$ID" "success"
            echo ""

          done < "$TMPFILE"
          rm -f "$TMPFILE"

          echo "=== ALL DONE ==="
