<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Setup Wizard — D365 App Updater</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://alcdn.msauth.net/browser/2.32.1/js/msal-browser.min.js"></script>
    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { background: #f5f6f8; min-height: 100vh; padding: 0; }
        .top-credit {
            background: linear-gradient(90deg, #0078d4 0%, #005a9e 100%);
            color: rgba(255,255,255,0.85);
            text-align: center;
            padding: 0.35rem 1rem;
            font-size: 0.72rem;
            letter-spacing: 0.02em;
        }
        .top-credit strong { color: #fff; font-weight: 600; }
        .top-credit a { color: rgba(255,255,255,0.9); text-decoration: none; }
        .top-credit a:hover { color: #fff; text-decoration: underline; }
        .wizard-page {
            min-height: calc(100vh - 28px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        .wizard-wrapper {
            width: 100%;
            max-width: 540px;
        }
        .wizard-brand {
            text-align: center;
            margin-bottom: 2rem;
        }
        .wizard-brand .brand-icon {
            width: 56px;
            height: 56px;
            background: #0078d4;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .wizard-brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.25rem;
        }
        .wizard-brand p {
            color: #6b7280;
            font-size: 0.9rem;
            margin: 0;
        }
        .main-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 24px rgba(0,0,0,0.04);
            border: 1px solid #e5e7eb;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }
        .step:last-child::before { display: none; }
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #9ca3af;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            position: relative;
            z-index: 1;
            margin-bottom: 0.5rem;
        }
        .step.active .step-circle { background: #0078d4; color: white; }
        .step.complete .step-circle { background: #10b981; color: white; }
        .step.complete .step-circle::after { display: none; }
        .step-label { font-size: 0.72rem; color: #6b7280; font-weight: 500; }
        .step.active .step-label { color: #0078d4; font-weight: 600; }
        .step.complete .step-label { color: #10b981; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .info-box {
            background: #f0f7ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }
        .info-box i { color: #0078d4; margin-right: 0.5rem; }
        .success-box {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .success-box i { color: #10b981; font-size: 3rem; margin-bottom: 1rem; }
        .error-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
            font-size: 0.85rem;
        }
        .error-box.show { display: block; }
        .error-box i { color: #ef4444; margin-right: 0.5rem; }
        .code-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 0.75rem 0;
            word-break: break-all;
        }
        .form-control {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.625rem 0.875rem;
            font-size: 0.9rem;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .form-control:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.12);
        }
        .form-text { font-size: 0.8rem; color: #9ca3af; margin-top: 0.375rem; }
        .btn-primary { background: #0078d4; border: none; padding: 0.65rem 1.5rem; font-weight: 600; border-radius: 8px; }
        .btn-primary:hover { background: #106ebe; }
        .btn-secondary { background: #6b7280; border: none; border-radius: 8px; }
        .btn-secondary:hover { background: #4b5563; }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .loading-spinner.show { display: block; }
        .spinner-border { color: #0078d4; }
        .permission-list {
            list-style: none;
            padding: 0;
            margin: 0.75rem 0;
        }
        .permission-list li {
            padding: 0.4rem 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }
        .permission-list li:last-child { border-bottom: none; }
        .permission-list i { color: #10b981; margin-right: 0.5rem; }
    </style>
</head>
<body>
    <div class="top-credit">
        <span>Built by <strong>Mauricio Oliveira</strong> — Contact Center GBB &nbsp;|&nbsp; <a href="mailto:mauricio.oliveira@microsoft.com">mauricio.oliveira@microsoft.com</a></span>
    </div>

    <div class="wizard-page">
        <div class="wizard-wrapper">
            <div class="wizard-brand">
                <h1>Setup Wizard</h1>
                <p>Set up your Azure AD app registration in 60 seconds</p>
            </div>

            <div class="main-card">
            <!-- Reset link for when stuck -->
            <div style="text-align: right; margin-bottom: 0.5rem;">
                <a href="#" onclick="resetWizard(); return false;" style="font-size: 0.75rem; color: #9ca3af;">
                    <i class="fas fa-redo"></i> Reset Wizard
                </a>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="stepInd1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Create App</div>
                </div>
                <div class="step" id="stepInd2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Sign In</div>
                </div>
                <div class="step" id="stepInd3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Configure</div>
                </div>
                <div class="step" id="stepInd4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>

            <!-- Step 1: Create Basic App -->
            <div class="step-content active" id="step1">
                <h3 class="mb-3">Step 1: Create App Registration</h3>
                <p class="text-muted mb-3">First, create a basic app registration in Azure Portal. This takes 30 seconds:</p>
                
                <div class="alert alert-info">
                    <strong><i class="fas fa-link me-2"></i>Quick Link:</strong>
                    <div class="mt-2">
                        <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/CreateApplicationBlade/quickStartType~/null/isMSAApp~/false" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt me-1"></i>Open Azure Portal (Create App)
                        </a>
                    </div>
                </div>

                <ol class="mb-4">
                    <li class="mb-3">
                        <strong>Name:</strong> Enter <code>D365 App Updater</code>
                    </li>
                    <li class="mb-3">
                        <strong>Supported account types:</strong> Keep default (Single tenant)
                    </li>
                    <li class="mb-3">
                        <strong>Redirect URI:</strong>
                        <div class="input-group mt-2">
                            <span class="input-group-text">Platform</span>
                            <select class="form-select" disabled>
                                <option>Single-page application (SPA)</option>
                            </select>
                        </div>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" id="redirectUriDisplay" value="" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyRedirectUri()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small class="text-muted">Copy this URL and paste it in the Redirect URI field</small>
                        <script>
                            // Set redirect URI dynamically to this page's URL
                            document.getElementById('redirectUriDisplay').value = window.location.origin + window.location.pathname;
                        </script>
                        <div class="mt-2">
                            <img src="img/demo.jpeg" alt="Example configuration" class="img-thumbnail" style="max-width:180px; cursor:pointer; border-radius:8px; opacity:0.9; transition:opacity 0.15s;" onclick="document.getElementById('imgModal').style.display='flex'" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                            <div class="text-muted mt-1" style="font-size:0.75rem;">Click to enlarge</div>
                        </div>
                    </li>
                    <li class="mb-3">
                        Click <strong>"Register"</strong>
                    </li>
                    <li class="mb-3">
                        <strong>Copy your Application (client) ID</strong> from the Overview page
                    </li>
                </ol>

                <div class="mb-3">
                    <label for="userClientId" class="form-label"><strong>Enter Your Client ID:</strong></label>
                    <input type="text" class="form-control" id="userClientId" placeholder="00000000-0000-0000-0000-000000000000">
                    <div class="form-text">Paste the Application (client) ID from the Overview page</div>
                </div>

                <div class="info-box mt-3">
                    <i class="fas fa-magic"></i>
                    <strong>What the wizard will do next:</strong>
                    <ul class="permission-list mt-2 mb-0">
                        <li><i class="fas fa-check"></i>Add Power Platform API permissions</li>
                        <li><i class="fas fa-check"></i>Add Dynamics CRM permissions</li>
                        <li><i class="fas fa-check"></i>Add Microsoft Graph permissions</li>
                        <li><i class="fas fa-check"></i>Add BAP API permissions</li>
                        <li><i class="fas fa-check"></i>Grant admin consent for all</li>
                    </ul>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-primary btn-lg" onclick="validateAndProceed()">
                        <i class="fas fa-arrow-right me-2"></i>Continue to Automated Setup
                    </button>
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to App
                    </a>
                </div>

                <div class="error-box" id="error1">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error1Text"></span>
                </div>
            </div>

            <!-- Step 2: Adding Permissions -->
            <div class="step-content" id="step2">
                <h3 class="mb-3">Signing In...</h3>
                
                <div class="loading-spinner show">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted" id="progressText">Please sign in when prompted...</p>
                </div>

                <div class="alert alert-info" style="display: none;" id="signInHint">
                    <i class="fas fa-info-circle me-2"></i>
                    You will be redirected to Microsoft to sign in. After signing in, you'll be returned here automatically.
                </div>

                <div class="error-box" id="error2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error2Text"></span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" onclick="resetWizard()">Start Over</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Configuring Permissions -->
            <div class="step-content" id="step3">
                <h3 class="mb-3">Configuring Permissions...</h3>
                
                <div class="loading-spinner show">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted" id="progressText">Authenticating...</p>
                </div>

                <div id="creationProgress" style="display: none;">
                    <ul class="list-unstyled">
                        <li class="mb-2" id="prog1"><i class="fas fa-spinner fa-spin text-primary me-2"></i>Creating app registration...</li>
                        <li class="mb-2" id="prog2"><i class="fas fa-circle text-muted me-2"></i>Adding API permissions...</li>
                        <li class="mb-2" id="prog3"><i class="fas fa-circle text-muted me-2"></i>Configuring authentication...</li>
                        <li class="mb-2" id="prog4"><i class="fas fa-circle text-muted me-2"></i>Granting admin consent...</li>
                    </ul>
                </div>

                <div class="error-box" id="error2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error2Text"></span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" onclick="resetWizard()">Start Over</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Configuring Permissions -->
            <div class="step-content" id="step3">
                <h3 class="mb-3">Configuring Permissions...</h3>
                
                <div id="creationProgress">
                    <ul class="list-unstyled">
                        <li class="mb-2" id="prog1"><i class="fas fa-circle text-muted me-2"></i>Adding Power Platform API...</li>
                        <li class="mb-2" id="prog2"><i class="fas fa-circle text-muted me-2"></i>Adding Dynamics CRM...</li>
                        <li class="mb-2" id="prog3"><i class="fas fa-circle text-muted me-2"></i>Adding Microsoft Graph...</li>
                        <li class="mb-2" id="prog4"><i class="fas fa-circle text-muted me-2"></i>Adding BAP API...</li>
                        <li class="mb-2" id="prog5"><i class="fas fa-circle text-muted me-2"></i>Granting admin consent...</li>
                    </ul>
                </div>

                <div class="error-box" id="error3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error3Text"></span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" onclick="resetWizard()">Start Over</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Complete -->
            <div class="step-content" id="step4">
                <div class="success-box">
                    <i class="fas fa-check-circle"></i>
                    <h3>Setup Complete!</h3>
                    <p class="text-muted mb-3">Your app registration is fully configured with all required permissions.</p>
                    
                    <div class="alert alert-success text-start">
                        <strong>All Permissions Added:</strong>
                        <ul class="mt-2 mb-0">
                            <li>✅ Power Platform API</li>
                            <li>✅ Dynamics CRM</li>
                            <li>✅ Microsoft Graph</li>
                            <li>✅ BAP/Environment Service</li>
                            <li>✅ Admin Consent Granted</li>
                        </ul>
                    </div>

                    <div class="alert alert-info text-start mt-3">
                        <strong>Your Client ID:</strong>
                        <div class="d-flex align-items-center gap-2 mt-2">
                            <div class="code-box flex-grow-1 mb-0" id="clientIdDisplay" style="margin:0;">Loading...</div>
                            <button class="btn btn-sm btn-light border" style="padding:0.35rem 0.5rem; line-height:1;" onclick="copyClientId()" title="Copy"><i class="fas fa-copy" style="font-size:0.85rem; color:#6b7280;"></i></button>
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3">Next Steps:</h5>
                    <ol class="text-start">
                        <li class="mb-2">Your Client ID is already saved above</li>
                        <li class="mb-2">Go to the <a href="index.html">D365 App Updater</a></li>
                        <li class="mb-2">Enter your Client ID and Tenant ID</li>
                        <li>Sign in and start updating apps!</li>
                    </ol>

                    <div class="d-grid gap-2 mt-4">
                        <a href="index.html" class="btn btn-primary btn-lg">Open D365 App Updater</a>
                    </div>
                </div>
            </div>
            </div><!-- end main-card -->
        </div><!-- end wizard-wrapper -->
    </div><!-- end wizard-page -->

    <script>
        let msalInstance = null;
        let adminAccessToken = null;
        let userProvidedClientId = null;

        // API Resource IDs (scope names used for dynamic lookup)
        const apiResources = {
            powerPlatform: { id: '8578e004-a5c6-46e7-913e-12f58912df43', scopeName: 'user_impersonation', name: 'Power Platform API' },
            dynamicsCrm: { id: '00000007-0000-0000-c000-000000000000', scopeName: 'user_impersonation', name: 'Dynamics CRM' },
            msGraph: { id: '00000003-0000-0000-c000-000000000000', scopeName: 'User.Read', name: 'Microsoft Graph' },
            bap: { id: '0e0bf3cc-3078-4fd4-9ef3-cb6dc0245b10', scopeName: 'user_impersonation', name: 'BAP API' }
        };

        // Debug logging for wizard
        function wizardLog(msg, data) {
            const ts = new Date().toISOString().split('T')[1].split('.')[0];
            console.log(`[WIZARD ${ts}] ${msg}`, data || '');
        }

        // On page load: check if we're returning from a redirect login
        document.addEventListener('DOMContentLoaded', async function() {
            wizardLog('Page loaded', { 
                url: window.location.href,
                hash: window.location.hash ? 'present (' + window.location.hash.length + ' chars)' : 'none',
                hasWizardClientId: !!sessionStorage.getItem('wizard_clientId'),
                hasWizardToken: !!sessionStorage.getItem('wizard_accessToken'),
                hasWizardError: !!sessionStorage.getItem('wizard_error')
            });

            const savedClientId = sessionStorage.getItem('wizard_clientId');
            
            // ═══════════════════════════════════════════════════════════════════════
            // DIRECT REDIRECT HANDLING: Process MSAL redirect right here on this page
            // ═══════════════════════════════════════════════════════════════════════
            if (savedClientId && window.location.hash) {
                wizardLog('Detected redirect with hash, processing MSAL response...');
                
                // Check for error in hash first
                if (window.location.hash.includes('error')) {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const error = hashParams.get('error');
                    const errorDesc = decodeURIComponent(hashParams.get('error_description') || 'Unknown error');
                    wizardLog('Error in redirect hash', { error, errorDesc });
                    
                    sessionStorage.removeItem('wizard_clientId');
                    history.replaceState(null, '', window.location.pathname);
                    showError(2, 'Sign-in failed: ' + errorDesc);
                    moveToStep(2);
                    document.getElementById('userClientId').value = savedClientId;
                    return;
                }
                
                try {
                    // Initialize MSAL with the saved client ID
                    const wizardMsalConfig = {
                        auth: {
                            clientId: savedClientId,
                            authority: 'https://login.microsoftonline.com/organizations',
                            redirectUri: window.location.origin + window.location.pathname // setup-wizard.html
                        },
                        cache: { cacheLocation: 'sessionStorage', storeAuthStateInCookie: false }
                    };
                    
                    const wizardMsal = new msal.PublicClientApplication(wizardMsalConfig);
                    await wizardMsal.initialize();
                    wizardLog('MSAL initialized for redirect handling');
                    
                    const response = await wizardMsal.handleRedirectPromise();
                    wizardLog('handleRedirectPromise result', response ? { 
                        hasToken: !!response.accessToken, 
                        scopes: response.scopes,
                        account: response.account?.username
                    } : 'null');
                    
                    // Clean URL
                    history.replaceState(null, '', window.location.pathname);
                    
                    if (response && response.accessToken) {
                        wizardLog('Token acquired successfully!');
                        userProvidedClientId = savedClientId;
                        adminAccessToken = response.accessToken;
                        document.getElementById('userClientId').value = savedClientId;
                        sessionStorage.removeItem('wizard_clientId');
                        
                        moveToStep(3);
                        await addPermissions();
                        return;
                    } else {
                        // No token in response, try silent acquisition
                        wizardLog('No token in redirect response, trying silent acquisition...');
                        const accounts = wizardMsal.getAllAccounts();
                        wizardLog('Accounts found', accounts.length);
                        
                        if (accounts.length > 0) {
                            try {
                                const silentResult = await wizardMsal.acquireTokenSilent({
                                    scopes: ['https://graph.microsoft.com/Application.ReadWrite.All', 'https://graph.microsoft.com/DelegatedPermissionGrant.ReadWrite.All'],
                                    account: accounts[0]
                                });
                                
                                if (silentResult && silentResult.accessToken) {
                                    wizardLog('Token acquired silently!');
                                    userProvidedClientId = savedClientId;
                                    adminAccessToken = silentResult.accessToken;
                                    document.getElementById('userClientId').value = savedClientId;
                                    sessionStorage.removeItem('wizard_clientId');
                                    
                                    moveToStep(3);
                                    await addPermissions();
                                    return;
                                }
                            } catch (silentErr) {
                                wizardLog('Silent token acquisition failed', silentErr.message);
                            }
                        }
                        
                        // Still no token
                        wizardLog('Failed to acquire token after redirect');
                        sessionStorage.removeItem('wizard_clientId');
                        showError(2, 'Failed to get access token. Please try signing in again.');
                        moveToStep(2);
                        document.getElementById('userClientId').value = savedClientId;
                        return;
                    }
                } catch (err) {
                    wizardLog('Error processing redirect', err.message);
                    history.replaceState(null, '', window.location.pathname);
                    sessionStorage.removeItem('wizard_clientId');
                    showError(2, 'Sign-in failed: ' + err.message);
                    moveToStep(2);
                    document.getElementById('userClientId').value = savedClientId;
                    return;
                }
            }
            
            // Check for error from previous attempt
            const wizardError = sessionStorage.getItem('wizard_error');
            if (wizardError) {
                wizardLog('Error found in storage', wizardError);
                sessionStorage.removeItem('wizard_error');
                sessionStorage.removeItem('wizard_clientId');
                sessionStorage.removeItem('wizard_accessToken');
                showError(2, 'Sign-in failed: ' + wizardError);
                moveToStep(2);
                return;
            }

            if (!savedClientId) {
                wizardLog('No pending wizard flow (no clientId in storage)');
                return; // No pending wizard flow
            }

            // Check for access token (set by app.js after processing redirect)
            const accessToken = sessionStorage.getItem('wizard_accessToken');
            wizardLog('Checking for access token', { hasToken: !!accessToken, tokenPreview: accessToken ? accessToken.substring(0, 20) + '...' : 'none' });
            
            if (!accessToken) {
                // No token and no error - something went wrong, show helpful message
                wizardLog('No token found, showing retry message');
                sessionStorage.removeItem('wizard_clientId');
                showError(2, 'Authentication did not complete. This can happen if pop-ups were blocked or the sign-in was cancelled. Please try again.');
                moveToStep(2);
                // Pre-fill the client ID so user doesn't have to re-enter
                document.getElementById('userClientId').value = savedClientId;
                return;
            }

            // We have the token! Clean up and proceed
            wizardLog('Token found! Proceeding to step 3');
            userProvidedClientId = savedClientId;
            adminAccessToken = accessToken;
            document.getElementById('userClientId').value = savedClientId;
            sessionStorage.removeItem('wizard_accessToken');
            sessionStorage.removeItem('wizard_clientId');

            moveToStep(3);
            await addPermissions();
        });

        function copyRedirectUri() {
            const text = document.getElementById('redirectUriDisplay').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('Redirect URI copied to clipboard!');
            });
        }

        function validateAndProceed() {
            const clientId = document.getElementById('userClientId').value.trim();
            if (!clientId) {
                showError(1, 'Please enter your Client ID');
                return;
            }

            // Basic UUID format validation
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(clientId)) {
                showError(1, 'Invalid Client ID format. It should look like: 00000000-0000-0000-0000-000000000000');
                return;
            }

            userProvidedClientId = clientId;
            showError(1, null);
            initializeMSAL();
        }

        function initializeMSAL() {
            // Clear ALL stale MSAL state from sessionStorage before starting fresh
            // This prevents "interaction_in_progress" errors from previous failed attempts
            const keysToRemove = [];
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && key.startsWith('msal.')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(k => sessionStorage.removeItem(k));

            // Use THIS PAGE (setup-wizard.html) as the redirect URI
            // This avoids cross-page issues with sessionStorage
            const msalConfig = {
                auth: {
                    clientId: userProvidedClientId,
                    authority: 'https://login.microsoftonline.com/organizations',
                    redirectUri: window.location.origin + window.location.pathname // setup-wizard.html
                },
                cache: {
                    cacheLocation: 'sessionStorage',
                    storeAuthStateInCookie: false
                }
            };
            
            wizardLog('Initializing MSAL', { 
                clientId: userProvidedClientId.substring(0, 8) + '...', 
                redirectUri: msalConfig.auth.redirectUri 
            });

            msalInstance = new msal.PublicClientApplication(msalConfig);
            moveToStep(2);
            signInAdmin();
        }

        function resetWizard() {
            wizardLog('Resetting wizard...');
            // Clear all wizard-related storage
            sessionStorage.removeItem('wizard_clientId');
            sessionStorage.removeItem('wizard_accessToken');
            sessionStorage.removeItem('wizard_error');
            // Clear MSAL state
            Object.keys(sessionStorage).forEach(key => {
                if (key.startsWith('msal.')) sessionStorage.removeItem(key);
            });
            // Reload page
            window.location.href = window.location.pathname;
        }

        async function signInAdmin() {
            try {
                await msalInstance.initialize();
                wizardLog('MSAL initialized for sign-in');

                document.getElementById('signInHint').style.display = 'block';
                document.getElementById('progressText').textContent = 'Redirecting to Microsoft sign-in...';
                
                // Save client ID so we can resume after redirect
                sessionStorage.setItem('wizard_clientId', userProvidedClientId);
                wizardLog('Saved clientId to sessionStorage, initiating loginRedirect...', {
                    clientId: userProvidedClientId.substring(0, 8) + '...',
                    redirectUri: msalInstance.getConfiguration().auth.redirectUri
                });

                await msalInstance.loginRedirect({
                    scopes: ['https://graph.microsoft.com/Application.ReadWrite.All', 'https://graph.microsoft.com/DelegatedPermissionGrant.ReadWrite.All'],
                    prompt: 'select_account'
                });
                // Browser navigates away — execution stops here
            } catch (error) {
                wizardLog('Login error', error.message);
                sessionStorage.removeItem('wizard_clientId');
                showError(2, 'Failed to sign in. Make sure you have Application Administrator or Global Admin role. Error: ' + error.message);
            }
        }

        async function addPermissions() {
            const skippedPermissions = [];
            const addedPermissions = [];
            
            try {
                showError(3, null);
                wizardLog('Starting permission addition...');
                
                // Get the app object ID
                const appsResponse = await fetch(`https://graph.microsoft.com/v1.0/applications?$filter=appId eq '${userProvidedClientId}'`, {
                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                });
                
                if (!appsResponse.ok) throw new Error('Failed to find app registration');
                
                const apps = await appsResponse.json();
                if (!apps.value || apps.value.length === 0) {
                    throw new Error('App not found. Make sure the Client ID is correct.');
                }
                
                const appObjectId = apps.value[0].id;
                wizardLog('Found app with Object ID: ' + appObjectId);
                let currentPermissions = apps.value[0].requiredResourceAccess || [];

                // Add each permission (dynamically look up scope IDs)
                let progressNum = 1;
                for (const [key, resource] of Object.entries(apiResources)) {
                    updateProgress(progressNum, 'running');
                    wizardLog(`Processing: ${resource.name}...`);
                    
                    // Look up the service principal to find the correct scope ID
                    const spResponse = await fetch(
                        `https://graph.microsoft.com/v1.0/servicePrincipals?$filter=appId eq '${resource.id}'&$select=id,appId,displayName,oauth2PermissionScopes`,
                        { headers: { 'Authorization': `Bearer ${adminAccessToken}` } }
                    );
                    const spData = await spResponse.json();
                    
                    if (!spData.value || spData.value.length === 0) {
                        // Try to create the service principal (this enables the API in the tenant)
                        wizardLog(`Service principal not found for ${resource.name}, attempting to create...`);
                        try {
                            const createSpResponse = await fetch('https://graph.microsoft.com/v1.0/servicePrincipals', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${adminAccessToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ appId: resource.id })
                            });
                            
                            if (createSpResponse.ok) {
                                const createdSp = await createSpResponse.json();
                                wizardLog(`Created service principal for ${resource.name}`);
                                spData.value = [createdSp];
                            } else {
                                const errText = await createSpResponse.text();
                                wizardLog(`Could not create SP for ${resource.name}: ${errText}`);
                                skippedPermissions.push(`${resource.name} (service principal not in tenant)`);
                                updateProgress(progressNum, 'error');
                                progressNum++;
                                continue;
                            }
                        } catch (createErr) {
                            wizardLog(`Failed to create SP for ${resource.name}: ${createErr.message}`);
                            skippedPermissions.push(`${resource.name} (service principal not in tenant)`);
                            updateProgress(progressNum, 'error');
                            progressNum++;
                            continue;
                        }
                    }
                    
                    const sp = spData.value[0];
                    wizardLog(`Found SP: ${sp.displayName || resource.name}`);
                    
                    const scope = sp.oauth2PermissionScopes?.find(s => s.value === resource.scopeName);
                    if (!scope) {
                        wizardLog(`Scope '${resource.scopeName}' not found for ${resource.name}. Available: ${sp.oauth2PermissionScopes?.map(s => s.value).join(', ') || 'none'}`);
                        skippedPermissions.push(`${resource.name} (scope '${resource.scopeName}' not found)`);
                        updateProgress(progressNum, 'error');
                        progressNum++;
                        continue;
                    }
                    
                    wizardLog(`Found scope: ${scope.value} (ID: ${scope.id})`);
                    
                    // Check if permission already exists
                    let resourceAccess = currentPermissions.find(r => r.resourceAppId === resource.id);
                    if (!resourceAccess) {
                        resourceAccess = {
                            resourceAppId: resource.id,
                            resourceAccess: []
                        };
                        currentPermissions.push(resourceAccess);
                    }
                    
                    // Add scope if not exists
                    const scopeExists = resourceAccess.resourceAccess.some(r => r.id === scope.id);
                    if (!scopeExists) {
                        resourceAccess.resourceAccess.push({
                            id: scope.id,
                            type: 'Scope'
                        });
                        addedPermissions.push(resource.name);
                        wizardLog(`Added permission: ${resource.name}`);
                    } else {
                        wizardLog(`Permission already exists: ${resource.name}`);
                        addedPermissions.push(`${resource.name} (already existed)`);
                    }
                    
                    updateProgress(progressNum, 'complete');
                    progressNum++;
                    await new Promise(r => setTimeout(r, 300));
                }

                // Update the app with all permissions at once
                wizardLog('Saving permissions to app registration...');
                wizardLog('Permissions payload: ' + JSON.stringify(currentPermissions, null, 2));
                
                const updateResponse = await fetch(`https://graph.microsoft.com/v1.0/applications/${appObjectId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${adminAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requiredResourceAccess: currentPermissions
                    })
                });

                if (!updateResponse.ok) {
                    const error = await updateResponse.text();
                    wizardLog('Failed to save permissions: ' + error);
                    throw new Error('Failed to add permissions: ' + error);
                }
                
                wizardLog('Permissions saved successfully!');

                // Grant admin consent
                updateProgress(5, 'running');
                wizardLog('Granting admin consent...');
                await grantAdminConsent(appObjectId);
                updateProgress(5, 'complete');
                wizardLog('Admin consent granted!');

                // Show summary
                if (skippedPermissions.length > 0) {
                    const warningHtml = `
                        <div class="alert alert-warning">
                            <strong>Partial Success:</strong> Some permissions could not be added automatically:
                            <ul class="mb-0 mt-2">
                                ${skippedPermissions.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                            <p class="mt-2 mb-0">You may need to add these manually in Azure Portal → App Registrations → API Permissions.</p>
                        </div>
                    `;
                    showError(3, warningHtml);
                }

                // Success!
                await new Promise(r => setTimeout(r, 1000));
                moveToStep(4);
                document.getElementById('clientIdDisplay').textContent = userProvidedClientId;
                
                // Show what was added
                if (addedPermissions.length > 0) {
                    wizardLog('Summary - Added permissions: ' + addedPermissions.join(', '));
                }
                if (skippedPermissions.length > 0) {
                    wizardLog('Summary - Skipped: ' + skippedPermissions.join(', '));
                }

            } catch (error) {
                console.error('Permission add error:', error);
                wizardLog('ERROR: ' + error.message);
                showError(3, `Failed to add permissions: ${error.message}. 
                    <br><br><strong>Skipped:</strong> ${skippedPermissions.join(', ') || 'none'}
                    <br><strong>Added:</strong> ${addedPermissions.join(', ') || 'none'}
                    <br><br>You may need to add them manually in Azure Portal.`);
            }
        }

        async function grantAdminConsent(appObjectId) {
            try {
                wizardLog('Starting admin consent process...');
                
                // Create service principal if it doesn't exist
                const spCheckResponse = await fetch(`https://graph.microsoft.com/v1.0/servicePrincipals?$filter=appId eq '${userProvidedClientId}'`, {
                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                });
                
                const spCheck = await spCheckResponse.json();
                let spId;
                
                if (!spCheck.value || spCheck.value.length === 0) {
                    // Create service principal
                    wizardLog('Creating service principal for the app...');
                    const createSpResponse = await fetch('https://graph.microsoft.com/v1.0/servicePrincipals', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminAccessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ appId: userProvidedClientId })
                    });
                    
                    if (createSpResponse.ok) {
                        const sp = await createSpResponse.json();
                        spId = sp.id;
                        wizardLog('Created service principal: ' + spId);
                    } else {
                        const errText = await createSpResponse.text();
                        wizardLog('Failed to create service principal: ' + errText);
                    }
                } else {
                    spId = spCheck.value[0].id;
                    wizardLog('Found existing service principal: ' + spId);
                }

                // Grant consents - need to look up each resource's service principal object ID
                if (spId) {
                    for (const resource of Object.values(apiResources)) {
                        try {
                            wizardLog(`Granting consent for ${resource.name}...`);
                            
                            // Look up the service principal for this resource API
                            const resourceSpResponse = await fetch(
                                `https://graph.microsoft.com/v1.0/servicePrincipals?$filter=appId eq '${resource.id}'&$select=id,displayName`,
                                { headers: { 'Authorization': `Bearer ${adminAccessToken}` } }
                            );
                            const resourceSpData = await resourceSpResponse.json();
                            
                            if (!resourceSpData.value || resourceSpData.value.length === 0) {
                                wizardLog(`Service principal not found for ${resource.name} - cannot grant consent`);
                                continue;
                            }
                            
                            const resourceSpId = resourceSpData.value[0].id;
                            wizardLog(`Found resource SP: ${resourceSpData.value[0].displayName} (${resourceSpId})`);
                            
                            // Use the scope specific to this API
                            const scope = resource.scopeName;
                            
                            const grantResponse = await fetch('https://graph.microsoft.com/v1.0/oauth2PermissionGrants', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${adminAccessToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    clientId: spId,
                                    consentType: 'AllPrincipals',
                                    principalId: null,
                                    resourceId: resourceSpId,
                                    scope: scope
                                })
                            });
                            
                            if (grantResponse.ok) {
                                wizardLog(`Admin consent granted for ${resource.name}!`);
                            } else {
                                const errText = await grantResponse.text();
                                // Check if it's because consent already exists
                                if (errText.includes('already exists')) {
                                    wizardLog(`Consent already exists for ${resource.name}`);
                                } else {
                                    wizardLog(`Consent grant for ${resource.name}: ${errText}`);
                                }
                            }
                        } catch (e) {
                            wizardLog(`Consent attempt for ${resource.name} - may need manual consent: ${e.message}`);
                        }
                    }
                } else {
                    wizardLog('No service principal ID - cannot grant consents');
                }
            } catch (error) {
                wizardLog('Admin consent may need to be granted manually: ' + error.message);
            }
        }

        function updateProgress(step, status) {
            const icons = {
                'running': '<i class="fas fa-spinner fa-spin text-primary me-2"></i>',
                'complete': '<i class="fas fa-check-circle text-success me-2"></i>',
                'error': '<i class="fas fa-times-circle text-danger me-2"></i>'
            };
            const prog = document.getElementById('prog' + step);
            if (prog) {
                const text = prog.textContent.replace(/^.*?([A-Z].*)$/, '$1');
                prog.innerHTML = icons[status] + text;
            }
        }

        function moveToStep(stepNum) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + stepNum).classList.add('active');

            document.querySelectorAll('.step-indicator .step').forEach((el, i) => {
                el.classList.remove('active', 'complete');
                if (i < stepNum - 1) el.classList.add('complete');
                if (i === stepNum - 1) el.classList.add('active');
            });
        }

        function showError(step, message) {
            const errorBox = document.getElementById('error' + step);
            const errorText = document.getElementById('error' + step + 'Text');
            if (message) {
                errorText.textContent = message;
                errorBox.classList.add('show');
            } else {
                errorBox.classList.remove('show');
            }
        }

        function copyClientId() {
            const text = document.getElementById('clientIdDisplay').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Client ID copied to clipboard!');
            });
        }

        function resetWizard() {
            adminAccessToken = null;
            userProvidedClientId = null;
            msalInstance = null;
            sessionStorage.removeItem('wizard_clientId');
            document.getElementById('userClientId').value = '';
            showError(1, null);
            showError(2, null);
            showError(3, null);
            moveToStep(1);
        }
    </script>

    <!-- Image Modal -->
    <div id="imgModal" style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px);" onclick="this.style.display='none'">
        <img src="img/demo.jpeg" alt="Example configuration" style="max-width:90vw; max-height:90vh; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
    </div>
</body>
</html>
