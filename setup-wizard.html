<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Setup Wizard — D365 App Updater</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://alcdn.msauth.net/browser/2.32.1/js/msal-browser.min.js"></script>
    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 2rem 0; }
        .top-credit {
            background: rgba(0,0,0,0.3);
            color: rgba(255,255,255,0.9);
            text-align: center;
            padding: 0.35rem 1rem;
            font-size: 0.72rem;
            letter-spacing: 0.02em;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        .top-credit strong { color: #fff; font-weight: 600; }
        .top-credit a { color: rgba(255,255,255,0.9); text-decoration: none; }
        .top-credit a:hover { color: #fff; text-decoration: underline; }
        .wizard-container {
            max-width: 700px;
            margin: 3rem auto 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .wizard-header {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .wizard-header h1 { font-size: 1.75rem; font-weight: 700; margin: 0 0 0.5rem; }
        .wizard-header p { margin: 0; opacity: 0.9; }
        .wizard-body { padding: 2rem; }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }
        .step:last-child::before { display: none; }
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #9ca3af;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            position: relative;
            z-index: 1;
            margin-bottom: 0.5rem;
        }
        .step.active .step-circle { background: #0078d4; color: white; }
        .step.complete .step-circle { background: #10b981; color: white; }
        .step.complete .step-circle::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        .step-label { font-size: 0.75rem; color: #6b7280; font-weight: 500; }
        .step.active .step-label { color: #0078d4; font-weight: 600; }
        .step.complete .step-label { color: #10b981; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .info-box {
            background: #f0f7ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .info-box i { color: #0078d4; margin-right: 0.5rem; }
        .success-box {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .success-box i { color: #10b981; font-size: 3rem; margin-bottom: 1rem; }
        .error-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        .error-box.show { display: block; }
        .error-box i { color: #ef4444; margin-right: 0.5rem; }
        .code-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            margin: 1rem 0;
            word-break: break-all;
        }
        .btn-primary { background: #0078d4; border: none; padding: 0.65rem 1.5rem; font-weight: 600; }
        .btn-primary:hover { background: #005a9e; }
        .btn-secondary { background: #6b7280; border: none; }
        .btn-secondary:hover { background: #4b5563; }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .loading-spinner.show { display: block; }
        .spinner-border { color: #0078d4; }
        .permission-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }
        .permission-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .permission-list li:last-child { border-bottom: none; }
        .permission-list i { color: #10b981; margin-right: 0.5rem; }
    </style>
</head>
<body>
    <div class="top-credit">
        <span>Built by <strong>Mauricio Oliveira</strong> — Contact Center GBB &nbsp;|&nbsp; <a href="mailto:mauricio.oliveira@microsoft.com">mauricio.oliveira@microsoft.com</a></span>
    </div>

    <div class="wizard-container">
        <div class="wizard-header">
            <h1><i class="fas fa-magic me-2"></i>Automated Setup Wizard</h1>
            <p>Set up your Azure AD app registration in 60 seconds</p>
        </div>

        <div class="wizard-body">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="stepInd1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Sign In</div>
                </div>
                <div class="step" id="stepInd2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Create App</div>
                </div>
                <div class="step" id="stepInd3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>

            <!-- Step 1: Sign In -->
            <div class="step-content active" id="step1">
                <h3 class="mb-3">Welcome to the Setup Wizard!</h3>
                <p class="text-muted mb-4">This wizard will automatically create and configure your Azure AD app registration. You'll need:</p>
                
                <ul style="list-style: none; padding-left: 0;">
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Global Administrator</strong> or <strong>Application Administrator</strong> role</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>A Microsoft 365 account with Azure AD access</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>~60 seconds of your time</li>
                </ul>

                <div class="info-box mt-4">
                    <i class="fas fa-info-circle"></i>
                    <strong>What will be created:</strong>
                    <ul class="permission-list mt-2 mb-0">
                        <li><i class="fas fa-check"></i>Azure AD App Registration</li>
                        <li><i class="fas fa-check"></i>Power Platform API permissions</li>
                        <li><i class="fas fa-check"></i>Dynamics CRM permissions</li>
                        <li><i class="fas fa-check"></i>Admin consent grants</li>
                        <li><i class="fas fa-check"></i>Redirect URIs configured</li>
                    </ul>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="signInAdmin()">
                        <i class="fas fa-user-shield me-2"></i>Sign In with Admin Account
                    </button>
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to App
                    </a>
                </div>

                <div class="error-box" id="error1">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error1Text"></span>
                </div>
            </div>

            <!-- Step 2: Creating App -->
            <div class="step-content" id="step2">
                <h3 class="mb-3">Creating Your App Registration...</h3>
                
                <div class="loading-spinner show">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted" id="progressText">Authenticating...</p>
                </div>

                <div id="creationProgress" style="display: none;">
                    <ul class="list-unstyled">
                        <li class="mb-2" id="prog1"><i class="fas fa-spinner fa-spin text-primary me-2"></i>Creating app registration...</li>
                        <li class="mb-2" id="prog2"><i class="fas fa-circle text-muted me-2"></i>Adding API permissions...</li>
                        <li class="mb-2" id="prog3"><i class="fas fa-circle text-muted me-2"></i>Configuring authentication...</li>
                        <li class="mb-2" id="prog4"><i class="fas fa-circle text-muted me-2"></i>Granting admin consent...</li>
                    </ul>
                </div>

                <div class="error-box" id="error2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error2Text"></span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" onclick="resetWizard()">Start Over</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Complete -->
            <div class="step-content" id="step3">
                <div class="success-box">
                    <i class="fas fa-check-circle"></i>
                    <h3>Setup Complete!</h3>
                    <p class="text-muted mb-3">Your app registration is ready to use.</p>
                    
                    <div class="alert alert-info text-start">
                        <strong><i class="fas fa-key me-2"></i>Your Client ID:</strong>
                        <div class="code-box mt-2" id="clientIdDisplay">Loading...</div>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyClientId()">
                            <i class="fas fa-copy me-1"></i>Copy to Clipboard
                        </button>
                    </div>

                    <h5 class="mt-4 mb-3">Next Steps:</h5>
                    <ol class="text-start">
                        <li class="mb-2">Copy your Client ID above</li>
                        <li class="mb-2">Go to the <a href="index.html">D365 App Updater</a></li>
                        <li class="mb-2">Enter your Client ID and sign in</li>
                        <li>Start updating apps!</li>
                    </ol>

                    <div class="d-grid gap-2 mt-4">
                        <a href="index.html" class="btn btn-primary btn-lg">
                            <i class="fas fa-arrow-right me-2"></i>Open D365 App Updater
                        </a>
                        <button class="btn btn-secondary" onclick="resetWizard()">
                            <i class="fas fa-redo me-2"></i>Create Another App
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MSAL Configuration for admin setup
        const msalConfig = {
            auth: {
                clientId: '00000003-0000-0000-c000-000000000000', // Microsoft Graph (well-known client ID)
                authority: 'https://login.microsoftonline.com/organizations',
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let adminAccessToken = null;
        let createdAppId = null;
        let createdClientId = null;

        // API Resource IDs
        const apiResources = {
            powerPlatform: '8578e004-a5c6-46e7-913e-12f58912df43',
            dynamicsCrm: '00000007-0000-0000-c000-000000000000',
            msGraph: '00000003-0000-0000-c000-000000000000',
            bap: '475226c6-020e-4fb2-8a90-7a972cbfc1d4',
            powerApps: '8109c6e9-c0b9-4c9a-a8b4-0e2a11d7a2a9'
        };

        async function signInAdmin() {
            try {
                showError(1, null);
                const loginRequest = {
                    scopes: ['Application.ReadWrite.All', 'Directory.AccessAsUser.All'],
                    prompt: 'select_account'
                };

                const response = await msalInstance.loginPopup(loginRequest);
                adminAccessToken = response.accessToken;
                
                moveToStep(2);
                await createAppRegistration();
            } catch (error) {
                console.error('Login error:', error);
                showError(1, 'Failed to sign in. Make sure you have Application Administrator or Global Admin role. Error: ' + error.message);
            }
        }

        async function createAppRegistration() {
            try {
                document.getElementById('creationProgress').style.display = 'block';
                document.querySelector('.loading-spinner').style.display = 'none';

                // Step 1: Create app registration
                updateProgress(1, 'running');
                const appData = {
                    displayName: 'D365 Power Platform App Updater',
                    signInAudience: 'AzureADMyOrg',
                    web: {
                        redirectUris: ['https://moliveirapinto.github.io/d365-app-updater/'],
                        implicitGrantSettings: {
                            enableAccessTokenIssuance: true,
                            enableIdTokenIssuance: true
                        }
                    },
                    spa: {
                        redirectUris: ['https://moliveirapinto.github.io/d365-app-updater/']
                    },
                    requiredResourceAccess: [
                        {
                            resourceAppId: apiResources.powerPlatform,
                            resourceAccess: [{ id: '9f7795e2-ce4f-42d1-b8c2-bc6c8af81d8f', type: 'Scope' }]
                        },
                        {
                            resourceAppId: apiResources.dynamicsCrm,
                            resourceAccess: [{ id: '78ce3f0f-a1ce-49c2-8cde-64b5c0896db4', type: 'Scope' }]
                        },
                        {
                            resourceAppId: apiResources.msGraph,
                            resourceAccess: [{ id: 'e1fe6dd8-ba31-4d61-89e7-88639da4683d', type: 'Scope' }]
                        }
                    ]
                };

                const createResponse = await fetch('https://graph.microsoft.com/v1.0/applications', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appData)
                });

                if (!createResponse.ok) {
                    const error = await createResponse.text();
                    throw new Error('Failed to create app: ' + error);
                }

                const app = await createResponse.json();
                createdAppId = app.id;
                createdClientId = app.appId;
                updateProgress(1, 'complete');

                // Step 2: Already added during creation
                updateProgress(2, 'complete');

                // Step 3: Configure authentication (already done in creation)
                updateProgress(3, 'complete');

                // Step 4: Grant admin consent
                updateProgress(4, 'running');
                await grantAdminConsent();
                updateProgress(4, 'complete');

                // Success!
                await new Promise(r => setTimeout(r, 1000));
                moveToStep(3);
                document.getElementById('clientIdDisplay').textContent = createdClientId;

            } catch (error) {
                console.error('Creation error:', error);
                showError(2, 'Failed to create app registration: ' + error.message + '. You may need to use the manual setup instead.');
            }
        }

        async function grantAdminConsent() {
            // Grant consent using Microsoft Graph
            try {
                const servicePrincipals = await fetch(`https://graph.microsoft.com/v1.0/servicePrincipals?$filter=appId eq '${createdClientId}'`, {
                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                }).then(r => r.json());

                if (servicePrincipals.value && servicePrincipals.value.length > 0) {
                    const spId = servicePrincipals.value[0].id;
                    
                    for (const resourceId of Object.values(apiResources)) {
                        try {
                            await fetch('https://graph.microsoft.com/v1.0/oauth2PermissionGrants', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${adminAccessToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    clientId: spId,
                                    consentType: 'AllPrincipals',
                                    resourceId: resourceId,
                                    scope: 'user_impersonation User.Read'
                                })
                            });
                        } catch (e) {
                            console.warn('Could not grant for resource:', resourceId, e);
                        }
                    }
                }
            } catch (error) {
                console.warn('Admin consent may need to be granted manually:', error);
            }
        }

        function updateProgress(step, status) {
            const icons = {
                'running': '<i class="fas fa-spinner fa-spin text-primary me-2"></i>',
                'complete': '<i class="fas fa-check-circle text-success me-2"></i>',
                'error': '<i class="fas fa-times-circle text-danger me-2"></i>'
            };
            const prog = document.getElementById('prog' + step);
            if (prog) {
                const text = prog.textContent.replace(/^.*?([A-Z].*)$/, '$1');
                prog.innerHTML = icons[status] + text;
            }
        }

        function moveToStep(stepNum) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + stepNum).classList.add('active');

            document.querySelectorAll('.step-indicator .step').forEach((el, i) => {
                el.classList.remove('active', 'complete');
                if (i < stepNum - 1) el.classList.add('complete');
                if (i === stepNum - 1) el.classList.add('active');
            });
        }

        function showError(step, message) {
            const errorBox = document.getElementById('error' + step);
            const errorText = document.getElementById('error' + step + 'Text');
            if (message) {
                errorText.textContent = message;
                errorBox.classList.add('show');
            } else {
                errorBox.classList.remove('show');
            }
        }

        function copyClientId() {
            const text = document.getElementById('clientIdDisplay').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Client ID copied to clipboard!');
            });
        }

        function resetWizard() {
            adminAccessToken = null;
            createdAppId = null;
            createdClientId = null;
            showError(1, null);
            showError(2, null);
            moveToStep(1);
        }

        // Handle redirect after popup
        msalInstance.handleRedirectPromise().catch(err => {
            console.error('Redirect error:', err);
        });
    </script>
</body>
</html>
