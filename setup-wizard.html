<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Setup Wizard — D365 App Updater</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://alcdn.msauth.net/browser/2.32.1/js/msal-browser.min.js"></script>
    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { background: #f5f6f8; min-height: 100vh; padding: 0; }
        .top-credit {
            background: linear-gradient(90deg, #0078d4 0%, #005a9e 100%);
            color: rgba(255,255,255,0.85);
            text-align: center;
            padding: 0.35rem 1rem;
            font-size: 0.72rem;
            letter-spacing: 0.02em;
        }
        .top-credit strong { color: #fff; font-weight: 600; }
        .top-credit a { color: rgba(255,255,255,0.9); text-decoration: none; }
        .top-credit a:hover { color: #fff; text-decoration: underline; }
        .wizard-page {
            min-height: calc(100vh - 28px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        .wizard-wrapper {
            width: 100%;
            max-width: 540px;
        }
        .wizard-brand {
            text-align: center;
            margin-bottom: 2rem;
        }
        .wizard-brand .brand-icon {
            width: 56px;
            height: 56px;
            background: #0078d4;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .wizard-brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.25rem;
        }
        .wizard-brand p {
            color: #6b7280;
            font-size: 0.9rem;
            margin: 0;
        }
        .main-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 24px rgba(0,0,0,0.04);
            border: 1px solid #e5e7eb;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: #e5e7eb;
            z-index: 0;
        }
        .step:last-child::before { display: none; }
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #9ca3af;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            position: relative;
            z-index: 1;
            margin-bottom: 0.5rem;
        }
        .step.active .step-circle { background: #0078d4; color: white; }
        .step.complete .step-circle { background: #10b981; color: white; }
        .step.complete .step-circle::after { display: none; }
        .step-label { font-size: 0.72rem; color: #6b7280; font-weight: 500; }
        .step.active .step-label { color: #0078d4; font-weight: 600; }
        .step.complete .step-label { color: #10b981; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .info-box {
            background: #f0f7ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }
        .info-box i { color: #0078d4; margin-right: 0.5rem; }
        .success-box {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .success-box i { color: #10b981; font-size: 3rem; margin-bottom: 1rem; }
        .error-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
            font-size: 0.85rem;
        }
        .error-box.show { display: block; }
        .error-box i { color: #ef4444; margin-right: 0.5rem; }
        .code-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 0.75rem 0;
            word-break: break-all;
        }
        .form-control {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.625rem 0.875rem;
            font-size: 0.9rem;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .form-control:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.12);
        }
        .form-text { font-size: 0.8rem; color: #9ca3af; margin-top: 0.375rem; }
        .btn-primary { background: #0078d4; border: none; padding: 0.65rem 1.5rem; font-weight: 600; border-radius: 8px; }
        .btn-primary:hover { background: #106ebe; }
        .btn-secondary { background: #6b7280; border: none; border-radius: 8px; }
        .btn-secondary:hover { background: #4b5563; }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .loading-spinner.show { display: block; }
        .spinner-border { color: #0078d4; }
        .permission-list {
            list-style: none;
            padding: 0;
            margin: 0.75rem 0;
        }
        .permission-list li {
            padding: 0.4rem 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }
        .permission-list li:last-child { border-bottom: none; }
        .permission-list i { color: #10b981; margin-right: 0.5rem; }
    </style>
</head>
<body>
    <div class="top-credit">
        <span>Built by <strong>Mauricio Oliveira</strong> — Contact Center GBB &nbsp;|&nbsp; <a href="mailto:mauricio.oliveira@microsoft.com">mauricio.oliveira@microsoft.com</a></span>
    </div>

    <div class="wizard-page">
        <div class="wizard-wrapper">
            <div class="wizard-brand">
                <h1>Setup Wizard</h1>
                <p>Set up your Azure AD app registration in 60 seconds</p>
            </div>

            <div class="main-card">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="stepInd1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Create App</div>
                </div>
                <div class="step" id="stepInd2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Sign In</div>
                </div>
                <div class="step" id="stepInd3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Configure</div>
                </div>
                <div class="step" id="stepInd4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Complete</div>
                </div>
            </div>

            <!-- Step 1: Create Basic App -->
            <div class="step-content active" id="step1">
                <h3 class="mb-3">Step 1: Create App Registration</h3>
                <p class="text-muted mb-3">First, create a basic app registration in Azure Portal. This takes 30 seconds:</p>
                
                <div class="alert alert-info">
                    <strong><i class="fas fa-link me-2"></i>Quick Link:</strong>
                    <div class="mt-2">
                        <a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/CreateApplicationBlade/quickStartType~/null/isMSAApp~/false" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt me-1"></i>Open Azure Portal (Create App)
                        </a>
                    </div>
                </div>

                <ol class="mb-4">
                    <li class="mb-3">
                        <strong>Name:</strong> Enter <code>D365 App Updater</code>
                    </li>
                    <li class="mb-3">
                        <strong>Supported account types:</strong> Keep default (Single tenant)
                    </li>
                    <li class="mb-3">
                        <strong>Redirect URI:</strong>
                        <div class="input-group mt-2">
                            <span class="input-group-text">Platform</span>
                            <select class="form-select" disabled>
                                <option>Single-page application (SPA)</option>
                            </select>
                        </div>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" id="redirectUriDisplay" value="https://moliveirapinto.github.io/d365-app-updater/" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyRedirectUri()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small class="text-muted">Copy this URL and paste it in the Redirect URI field</small>
                        <div class="mt-2">
                            <img src="img/demo.jpeg" alt="Example configuration" class="img-thumbnail" style="max-width:180px; cursor:pointer; border-radius:8px; opacity:0.9; transition:opacity 0.15s;" onclick="document.getElementById('imgModal').style.display='flex'" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                            <div class="text-muted mt-1" style="font-size:0.75rem;">Click to enlarge</div>
                        </div>
                    </li>
                    <li class="mb-3">
                        Click <strong>"Register"</strong>
                    </li>
                    <li class="mb-3">
                        <strong>Copy your Application (client) ID</strong> from the Overview page
                    </li>
                </ol>

                <div class="mb-3">
                    <label for="userClientId" class="form-label"><strong>Enter Your Client ID:</strong></label>
                    <input type="text" class="form-control" id="userClientId" placeholder="00000000-0000-0000-0000-000000000000">
                    <div class="form-text">Paste the Application (client) ID from the Overview page</div>
                </div>

                <div class="info-box mt-3">
                    <i class="fas fa-magic"></i>
                    <strong>What the wizard will do next:</strong>
                    <ul class="permission-list mt-2 mb-0">
                        <li><i class="fas fa-check"></i>Add Power Platform API permissions</li>
                        <li><i class="fas fa-check"></i>Add Dynamics CRM permissions</li>
                        <li><i class="fas fa-check"></i>Add Microsoft Graph permissions</li>
                        <li><i class="fas fa-check"></i>Add BAP API permissions</li>
                        <li><i class="fas fa-check"></i>Grant admin consent for all</li>
                    </ul>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button class="btn btn-primary btn-lg" onclick="validateAndProceed()">
                        <i class="fas fa-arrow-right me-2"></i>Continue to Automated Setup
                    </button>
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to App
                    </a>
                </div>

                <div class="error-box" id="error1">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error1Text"></span>
                </div>
            </div>

            <!-- Step 2: Adding Permissions -->
            <div class="step-content" id="step2">
                <h3 class="mb-3">Signing In...</h3>
                
                <div class="loading-spinner show">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted" id="progressText">Please sign in when prompted...</p>
                </div>

                <div class="alert alert-info" style="display: none;" id="signInHint">
                    <i class="fas fa-info-circle me-2"></i>
                    A popup window will open for you to sign in. Make sure popups are enabled.
                </div>

                <div class="error-box" id="error2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error2Text"></span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" onclick="resetWizard()">Start Over</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Configuring Permissions -->
            <div class="step-content" id="step3">
                <h3 class="mb-3">Configuring Permissions...</h3>
                
                <div class="loading-spinner show">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted" id="progressText">Authenticating...</p>
                </div>

                <div id="creationProgress" style="display: none;">
                    <ul class="list-unstyled">
                        <li class="mb-2" id="prog1"><i class="fas fa-spinner fa-spin text-primary me-2"></i>Creating app registration...</li>
                        <li class="mb-2" id="prog2"><i class="fas fa-circle text-muted me-2"></i>Adding API permissions...</li>
                        <li class="mb-2" id="prog3"><i class="fas fa-circle text-muted me-2"></i>Configuring authentication...</li>
                        <li class="mb-2" id="prog4"><i class="fas fa-circle text-muted me-2"></i>Granting admin consent...</li>
                    </ul>
                </div>

                <div class="error-box" id="error2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error2Text"></span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" onclick="resetWizard()">Start Over</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Configuring Permissions -->
            <div class="step-content" id="step3">
                <h3 class="mb-3">Configuring Permissions...</h3>
                
                <div id="creationProgress">
                    <ul class="list-unstyled">
                        <li class="mb-2" id="prog1"><i class="fas fa-circle text-muted me-2"></i>Adding Power Platform API...</li>
                        <li class="mb-2" id="prog2"><i class="fas fa-circle text-muted me-2"></i>Adding Dynamics CRM...</li>
                        <li class="mb-2" id="prog3"><i class="fas fa-circle text-muted me-2"></i>Adding Microsoft Graph...</li>
                        <li class="mb-2" id="prog4"><i class="fas fa-circle text-muted me-2"></i>Adding BAP API...</li>
                        <li class="mb-2" id="prog5"><i class="fas fa-circle text-muted me-2"></i>Granting admin consent...</li>
                    </ul>
                </div>

                <div class="error-box" id="error3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="error3Text"></span>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" onclick="resetWizard()">Start Over</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Complete -->
            <div class="step-content" id="step4">
                <div class="success-box">
                    <i class="fas fa-check-circle"></i>
                    <h3>Setup Complete!</h3>
                    <p class="text-muted mb-3">Your app registration is fully configured with all required permissions.</p>
                    
                    <div class="alert alert-success text-start">
                        <strong>All Permissions Added:</strong>
                        <ul class="mt-2 mb-0">
                            <li>✅ Power Platform API</li>
                            <li>✅ Dynamics CRM</li>
                            <li>✅ Microsoft Graph</li>
                            <li>✅ BAP/Environment Service</li>
                            <li>✅ Admin Consent Granted</li>
                        </ul>
                    </div>

                    <div class="alert alert-info text-start mt-3">
                        <strong>Your Client ID:</strong>
                        <div class="d-flex align-items-center gap-2 mt-2">
                            <div class="code-box flex-grow-1 mb-0" id="clientIdDisplay" style="margin:0;">Loading...</div>
                            <button class="btn btn-sm btn-light border" style="padding:0.35rem 0.5rem; line-height:1;" onclick="copyClientId()" title="Copy"><i class="fas fa-copy" style="font-size:0.85rem; color:#6b7280;"></i></button>
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3">Next Steps:</h5>
                    <ol class="text-start">
                        <li class="mb-2">Your Client ID is already saved above</li>
                        <li class="mb-2">Go to the <a href="index.html">D365 App Updater</a></li>
                        <li class="mb-2">Enter your Client ID and Tenant ID</li>
                        <li>Sign in and start updating apps!</li>
                    </ol>

                    <div class="d-grid gap-2 mt-4">
                        <a href="index.html" class="btn btn-primary btn-lg">Open D365 App Updater</a>
                    </div>
                </div>
            </div>
            </div><!-- end main-card -->
        </div><!-- end wizard-wrapper -->
    </div><!-- end wizard-page -->

    <script>
        let msalInstance = null;
        let adminAccessToken = null;
        let userProvidedClientId = null;

        // API Resource IDs (scope names used for dynamic lookup)
        const apiResources = {
            powerPlatform: { id: '8578e004-a5c6-46e7-913e-12f58912df43', scopeName: 'user_impersonation', name: 'Power Platform API' },
            dynamicsCrm: { id: '00000007-0000-0000-c000-000000000000', scopeName: 'user_impersonation', name: 'Dynamics CRM' },
            msGraph: { id: '00000003-0000-0000-c000-000000000000', scopeName: 'User.Read', name: 'Microsoft Graph' },
            bap: { id: '0e0bf3cc-3078-4fd4-9ef3-cb6dc0245b10', scopeName: 'user_impersonation', name: 'BAP API' }
        };

        function copyRedirectUri() {
            const text = document.getElementById('redirectUriDisplay').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('Redirect URI copied to clipboard!');
            });
        }

        function validateAndProceed() {
            const clientId = document.getElementById('userClientId').value.trim();
            if (!clientId) {
                showError(1, 'Please enter your Client ID');
                return;
            }

            // Basic UUID format validation
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(clientId)) {
                showError(1, 'Invalid Client ID format. It should look like: 00000000-0000-0000-0000-000000000000');
                return;
            }

            userProvidedClientId = clientId;
            showError(1, null);
            initializeMSAL();
        }

        function initializeMSAL() {
            const msalConfig = {
                auth: {
                    clientId: userProvidedClientId,
                    authority: 'https://login.microsoftonline.com/organizations',
                    redirectUri: 'https://moliveirapinto.github.io/d365-app-updater/'
                },
                cache: {
                    cacheLocation: 'sessionStorage',
                    storeAuthStateInCookie: false
                }
            };

            msalInstance = new msal.PublicClientApplication(msalConfig);
            moveToStep(2);
            signInAdmin();
        }

        async function signInAdmin() {
            try {
                document.getElementById('signInHint').style.display = 'block';
                document.getElementById('progressText').textContent = 'Please sign in when prompted...';
                
                const loginRequest = {
                    scopes: ['Application.ReadWrite.All', 'DelegatedPermissionGrant.ReadWrite.All'],
                    prompt: 'select_account'
                };

                const response = await msalInstance.loginPopup(loginRequest);
                adminAccessToken = response.accessToken;
                
                moveToStep(3);
                await addPermissions();
            } catch (error) {
                console.error('Login error:', error);
                showError(2, 'Failed to sign in. Make sure you have Application Administrator or Global Admin role. Error: ' + error.message);
            }
        }

        async function addPermissions() {
            try {
                showError(3, null);
                
                // Get the app object ID
                const appsResponse = await fetch(`https://graph.microsoft.com/v1.0/applications?$filter=appId eq '${userProvidedClientId}'`, {
                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                });
                
                if (!appsResponse.ok) throw new Error('Failed to find app registration');
                
                const apps = await appsResponse.json();
                if (!apps.value || apps.value.length === 0) {
                    throw new Error('App not found. Make sure the Client ID is correct.');
                }
                
                const appObjectId = apps.value[0].id;
                let currentPermissions = apps.value[0].requiredResourceAccess || [];

                // Add each permission (dynamically look up scope IDs)
                let progressNum = 1;
                for (const [key, resource] of Object.entries(apiResources)) {
                    updateProgress(progressNum, 'running');
                    
                    // Look up the service principal to find the correct scope ID
                    const spResponse = await fetch(
                        `https://graph.microsoft.com/v1.0/servicePrincipals?$filter=appId eq '${resource.id}'&$select=id,oauth2PermissionScopes`,
                        { headers: { 'Authorization': `Bearer ${adminAccessToken}` } }
                    );
                    const spData = await spResponse.json();
                    if (!spData.value || spData.value.length === 0) {
                        console.warn('Service principal not found for', resource.name, '- skipping');
                        updateProgress(progressNum, 'complete');
                        progressNum++;
                        continue;
                    }
                    
                    const sp = spData.value[0];
                    const scope = sp.oauth2PermissionScopes.find(s => s.value === resource.scopeName);
                    if (!scope) {
                        console.warn('Scope', resource.scopeName, 'not found for', resource.name, '- skipping');
                        updateProgress(progressNum, 'complete');
                        progressNum++;
                        continue;
                    }
                    
                    // Check if permission already exists
                    let resourceAccess = currentPermissions.find(r => r.resourceAppId === resource.id);
                    if (!resourceAccess) {
                        resourceAccess = {
                            resourceAppId: resource.id,
                            resourceAccess: []
                        };
                        currentPermissions.push(resourceAccess);
                    }
                    
                    // Add scope if not exists
                    const scopeExists = resourceAccess.resourceAccess.some(r => r.id === scope.id);
                    if (!scopeExists) {
                        resourceAccess.resourceAccess.push({
                            id: scope.id,
                            type: 'Scope'
                        });
                    }
                    
                    updateProgress(progressNum, 'complete');
                    progressNum++;
                    await new Promise(r => setTimeout(r, 300));
                }

                // Update the app with all permissions at once
                const updateResponse = await fetch(`https://graph.microsoft.com/v1.0/applications/${appObjectId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${adminAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requiredResourceAccess: currentPermissions
                    })
                });

                if (!updateResponse.ok) {
                    const error = await updateResponse.text();
                    throw new Error('Failed to add permissions: ' + error);
                }

                // Grant admin consent
                updateProgress(5, 'running');
                await grantAdminConsent(appObjectId);
                updateProgress(5, 'complete');

                // Success!
                await new Promise(r => setTimeout(r, 1000));
                moveToStep(4);
                document.getElementById('clientIdDisplay').textContent = userProvidedClientId;

            } catch (error) {
                console.error('Permission add error:', error);
                showError(3, 'Failed to add permissions: ' + error.message + '. You may need to add them manually in Azure Portal.');
            }
        }

        async function grantAdminConsent(appObjectId) {
            try {
                // Create service principal if it doesn't exist
                const spCheckResponse = await fetch(`https://graph.microsoft.com/v1.0/servicePrincipals?$filter=appId eq '${userProvidedClientId}'`, {
                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                });
                
                const spCheck = await spCheckResponse.json();
                let spId;
                
                if (!spCheck.value || spCheck.value.length === 0) {
                    // Create service principal
                    const createSpResponse = await fetch('https://graph.microsoft.com/v1.0/servicePrincipals', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminAccessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ appId: userProvidedClientId })
                    });
                    
                    if (createSpResponse.ok) {
                        const sp = await createSpResponse.json();
                        spId = sp.id;
                    }
                } else {
                    spId = spCheck.value[0].id;
                }

                // Grant consents - need to look up each resource's service principal object ID
                if (spId) {
                    for (const resource of Object.values(apiResources)) {
                        try {
                            // Look up the service principal for this resource API
                            const resourceSpResponse = await fetch(
                                `https://graph.microsoft.com/v1.0/servicePrincipals?$filter=appId eq '${resource.id}'&$select=id`,
                                { headers: { 'Authorization': `Bearer ${adminAccessToken}` } }
                            );
                            const resourceSpData = await resourceSpResponse.json();
                            
                            if (!resourceSpData.value || resourceSpData.value.length === 0) {
                                console.warn('Service principal not found for', resource.name);
                                continue;
                            }
                            
                            const resourceSpId = resourceSpData.value[0].id;
                            
                            const grantResponse = await fetch('https://graph.microsoft.com/v1.0/oauth2PermissionGrants', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${adminAccessToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    clientId: spId,
                                    consentType: 'AllPrincipals',
                                    principalId: null,
                                    resourceId: resourceSpId,
                                    scope: 'user_impersonation User.Read User'
                                })
                            });
                            
                            if (!grantResponse.ok) {
                                const errText = await grantResponse.text();
                                console.warn('Consent grant for', resource.name, ':', errText);
                            }
                        } catch (e) {
                            console.warn('Consent grant attempt for', resource.name, '- may need manual consent:', e);
                        }
                    }
                }
            } catch (error) {
                console.warn('Admin consent may need to be granted manually:', error);
            }
        }

        function updateProgress(step, status) {
            const icons = {
                'running': '<i class="fas fa-spinner fa-spin text-primary me-2"></i>',
                'complete': '<i class="fas fa-check-circle text-success me-2"></i>',
                'error': '<i class="fas fa-times-circle text-danger me-2"></i>'
            };
            const prog = document.getElementById('prog' + step);
            if (prog) {
                const text = prog.textContent.replace(/^.*?([A-Z].*)$/, '$1');
                prog.innerHTML = icons[status] + text;
            }
        }

        function moveToStep(stepNum) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + stepNum).classList.add('active');

            document.querySelectorAll('.step-indicator .step').forEach((el, i) => {
                el.classList.remove('active', 'complete');
                if (i < stepNum - 1) el.classList.add('complete');
                if (i === stepNum - 1) el.classList.add('active');
            });
        }

        function showError(step, message) {
            const errorBox = document.getElementById('error' + step);
            const errorText = document.getElementById('error' + step + 'Text');
            if (message) {
                errorText.textContent = message;
                errorBox.classList.add('show');
            } else {
                errorBox.classList.remove('show');
            }
        }

        function copyClientId() {
            const text = document.getElementById('clientIdDisplay').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Client ID copied to clipboard!');
            });
        }

        function resetWizard() {
            adminAccessToken = null;
            userProvidedClientId = null;
            msalInstance = null;
            document.getElementById('userClientId').value = '';
            showError(1, null);
            showError(2, null);
            showError(3, null);
            moveToStep(1);
        }

        // Handle redirect after popup (if needed)
        if (msalInstance) {
            msalInstance.handleRedirectPromise().catch(err => {
                console.error('Redirect error:', err);
            });
        }
    </script>

    <!-- Image Modal -->
    <div id="imgModal" style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px);" onclick="this.style.display='none'">
        <img src="img/demo.jpeg" alt="Example configuration" style="max-width:90vw; max-height:90vh; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
    </div>
</body>
</html>
